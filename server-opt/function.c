#include "function.h"

#define PRIME 3
uint64_t CONSTANT = 1UL << 32;
uint32_t generated_multiplier_adder[12][2] = {0};
uint64_t total_write_bytes = 0;
int INITIALIZE = 0;
/*
 *randomly generated coprime mutiplier and adder
*/
uint32_t array_of_prime[]={
	84131, 84137, 84143, 84163, 84179, 84181, 84191, 84199, 84211, 84221,
	84223, 84229, 84239, 84247, 84263, 84299, 84307, 84313, 84317, 84319,
	84347, 84349, 84377, 84389, 84391, 84401, 84407, 84421, 84431, 84437,
	84443, 84449, 84457, 84463, 84467, 84481, 84499, 84503, 84509, 84521,
	84523, 84533, 84551, 84559, 84589, 84629, 84631, 84649, 84653, 84659,
	84673, 84691, 84697, 84701, 84713, 84719, 84731, 84737, 84751, 84761,
	84787, 84793, 84809, 84811, 84827, 84857, 84859, 84869, 84871, 84913,
	84919, 84947, 84961, 84967, 84977, 84979, 84991, 85009, 85021, 85027,
	85037, 85049, 85061, 85081, 85087, 85091, 85093, 85103, 85109, 85121,
	85133, 85147, 85159, 85193, 85199, 85201, 85213, 85223, 85229, 85237,
	85243, 85247, 85259, 85297, 85303, 85313, 85331, 85333, 85361, 85363,
	85369, 85381, 85411, 85427, 85429, 85439, 85447, 85451, 85453, 85469,
	85487, 85513, 85517, 85523, 85531, 85549, 85571, 85577, 85597, 85601,
	85607, 85619, 85621, 85627, 85639, 85643, 85661, 85667, 85669, 85691,
	85703, 85711, 85717, 85733, 85751, 85781, 85793, 85817, 85819, 85829,
	85831, 85837, 85843, 85847, 85853, 85889, 85903, 85909, 85931, 85933,
	85991, 85999, 86011, 86017, 86027, 86029, 86069, 86077, 86083, 86111,
	86113, 86117, 86131, 86137, 86143, 86161, 86171, 86179, 86183, 86197,
	86201, 86209, 86239, 86243, 86249, 86257, 86263, 86269, 86287, 86291,
	86293, 86297, 86311, 86323, 86341, 86351, 86353, 86357, 86369, 86371,
	86381, 86389, 86399, 86413, 86423, 86441, 86453, 86461, 86467, 86477,
	86491, 86501, 86509, 86531, 86533, 86539, 86561, 86573, 86579, 86587,
	86599, 86627, 86629, 86677, 86689, 86693, 86711, 86719, 86729, 86743,
	86753, 86767, 86771, 86783, 86813, 86837, 86843, 86851, 86857, 86861,
	86869, 86923, 86927, 86929, 86939, 86951, 86959, 86969, 86981, 86993,
	87011, 87013, 87037, 87041, 87049, 87071, 87083, 87103, 87107, 87119,
	87121, 87133, 87149, 87151, 87179, 87181, 87187, 87211, 87221, 87223,
	87251, 87253, 87257, 87277, 87281, 87293, 87299, 87313, 87317, 87323,
	87337, 87359, 87383, 87403, 87407, 87421, 87427, 87433, 87443, 87473,
	87481, 87491, 87509, 87511, 87517, 87523, 87539, 87541, 87547, 87553,
	87557, 87559, 87583, 87587, 87589, 87613, 87623, 87629, 87631, 87641,
	87643, 87649, 87671, 87679, 87683, 87691, 87697, 87701, 87719, 87721,
	87739, 87743, 87751, 87767, 87793, 87797, 87803, 87811, 87833, 87853,
	87869, 87877, 87881, 87887, 87911, 87917, 87931, 87943, 87959, 87961,
	87973, 87977, 87991, 88001, 88003, 88007, 88019, 88037, 88069, 88079,
	88093, 88117, 88129, 88169, 88177, 88211, 88223, 88237, 88241, 88259,
	88261, 88289, 88301, 88321, 88327, 88337, 88339, 88379, 88397, 88411,
	88423, 88427, 88463, 88469, 88471, 88493, 88499, 88513, 88523, 88547,
	88589, 88591, 88607, 88609, 88643, 88651, 88657, 88661, 88663, 88667,
	88681, 88721, 88729, 88741, 88747, 88771, 88789, 88793, 88799, 88801,
	88807, 88811, 88813, 88817, 88819, 88843, 88853, 88861, 88867, 88873,
	88883, 88897, 88903, 88919, 88937, 88951, 88969, 88993, 88997, 89003,
	89009, 89017, 89021, 89041, 89051, 89057, 89069, 89071, 89083, 89087,
	89101, 89107, 89113, 89119, 89123, 89137, 89153, 89189, 89203, 89209,
	89213, 89227, 89231, 89237, 89261, 89269, 89273, 89293, 89303, 89317,
	89329, 89363, 89371, 89381, 89387, 89393, 89399, 89413, 89417, 89431,
	89443, 89449, 89459, 89477, 89491, 89501, 89513, 89519, 89521, 89527,
	89533, 89561, 89563, 89567, 89591, 89597, 89599, 89603, 89611, 89627,
	89633, 89653, 89657, 89659, 89669, 89671, 89681, 89689, 89753, 89759,
	89767, 89779, 89783, 89797, 89809, 89819, 89821, 89833, 89839, 89849,
	89867, 89891, 89897, 89899, 89909, 89917, 89923, 89939, 89959, 89963,
	89977, 89983, 89989, 90001, 90007, 90011, 90017, 90019, 90023, 90031,
	90053, 90059, 90067, 90071, 90073, 90089, 90107, 90121, 90127, 90149,
	90163, 90173, 90187, 90191, 90197, 90199, 90203, 90217, 90227, 90239,
	90247, 90263, 90271, 90281, 90289, 90313, 90353, 90359, 90371, 90373,
	90379, 90397, 90401, 90403, 90407, 90437, 90439, 90469, 90473, 90481,
	90499, 90511, 90523, 90527, 90529, 90533, 90547, 90583, 90599, 90617,
	90619, 90631, 90641, 90647, 90659, 90677, 90679, 90697, 90703, 90709,
	90731, 90749, 90787, 90793, 90803, 90821, 90823, 90833, 90841, 90847,
	90863, 90887, 90901, 90907, 90911, 90917, 90931, 90947, 90971, 90977,
	90989, 90997, 91009, 91019, 91033, 91079, 91081, 91097, 91099, 91121,
	91127, 91129, 91139, 91141, 91151, 91153, 91159, 91163, 91183, 91193,
	91199, 91229, 91237, 91243, 91249, 91253, 91283, 91291, 91297, 91303,
	91309, 91331, 91367, 91369, 91373, 91381, 91387, 91393, 91397, 91411,
	91423, 91433, 91453, 91457, 91459, 91463, 91493, 91499, 91513, 91529,
	91541, 91571, 91573, 91577, 91583, 91591, 91621, 91631, 91639, 91673,
	91691, 91703, 91711, 91733, 91753, 91757, 91771, 91781, 91801, 91807,
	91811, 91813, 91823, 91837, 91841, 91867, 91873, 91909, 91921, 91939,
	91943, 91951, 91957, 91961, 91967, 91969, 91997, 92003, 92009, 92033,
	92041, 92051, 92077, 92083, 92107, 92111, 92119, 92143, 92153, 92173,
	92177, 92179, 92189, 92203, 92219, 92221, 92227, 92233, 92237, 92243,
	92251, 92269, 92297, 92311, 92317, 92333, 92347, 92353, 92357, 92363,
	92369, 92377, 92381, 92383, 92387, 92399, 92401, 92413, 92419, 92431,
	92459, 92461, 92467, 92479, 92489, 92503, 92507, 92551, 92557, 92567,
	92569, 92581, 92593, 92623, 92627, 92639, 92641, 92647, 92657, 92669,
	92671, 92681, 92683, 92693, 92699, 92707, 92717, 92723, 92737, 92753,
	92761, 92767, 92779, 92789, 92791, 92801, 92809, 92821, 92831, 92849,
	92857, 92861, 92863, 92867, 92893, 92899, 92921, 92927, 92941, 92951,
	92957, 92959, 92987, 92993, 93001, 93047, 93053, 93059, 93077, 93083,
	93089, 93097, 93103, 93113, 93131, 93133, 93139, 93151, 93169, 93179,
	93187, 93199, 93229, 93239, 93241, 93251, 93253, 93257, 93263, 93281,
	93283, 93287, 93307, 93319, 93323, 93329, 93337, 93371, 93377, 93383,
	93407, 93419, 93427, 93463, 93479, 93481, 93487, 93491, 93493, 93497,
	93503, 93523, 93529, 93553, 93557, 93559, 93563, 93581, 93601, 93607,
	93629, 93637, 93683, 93701, 93703, 93719, 93739, 93761, 93763, 93787,
	93809, 93811, 93827, 93851, 93871, 93887, 93889, 93893, 93901, 93911,
	93913, 93923, 93937, 93941, 93949, 93967, 93971, 93979, 93983, 93997,
	94007, 94009, 94033, 94049, 94057, 94063, 94079, 94099, 94109, 94111,
	94117, 94121, 94151, 94153, 94169, 94201, 94207, 94219, 94229, 94253,
	94261, 94273, 94291, 94307, 94309, 94321, 94327, 94331, 94343, 94349,
	94351, 94379, 94397, 94399, 94421, 94427, 94433, 94439, 94441, 94447,
	94463, 94477, 94483, 94513, 94529, 94531, 94541, 94543, 94547, 94559,
	94561, 94573, 94583, 94597, 94603, 94613, 94621, 94649, 94651, 94687,
	94693, 94709, 94723, 94727, 94747, 94771, 94777, 94781, 94789, 94793,
	94811, 94819, 94823, 94837, 94841, 94847, 94849, 94873, 94889, 94903,
	94907, 94933, 94949, 94951, 94961, 94993, 94999, 95003, 95009, 95021,
	95027, 95063, 95071, 95083, 95087, 95089, 95093, 95101, 95107, 95111,
	95131, 95143, 95153, 95177, 95189, 95191, 95203, 95213, 95219, 95231,
	95233, 95239, 95257, 95261, 95267, 95273, 95279, 95287, 95311, 95317,
	95327, 95339, 95369, 95383, 95393, 95401, 95413, 95419, 95429, 95441,
	95443, 95461, 95467, 95471, 95479, 95483, 95507, 95527, 95531, 95539,
	95549, 95561, 95569, 95581, 95597, 95603, 95617, 95621, 95629, 95633,
	95651, 95701, 95707, 95713, 95717, 95723, 95731, 95737, 95747, 95773,
	95783, 95789, 95791, 95801, 95803, 95813, 95819, 95857, 95869, 95873,
	95881, 95891, 95911, 95917, 95923, 95929, 95947, 95957, 95959, 95971,
	95987, 95989, 96001, 96013, 96017, 96043, 96053, 96059, 96079, 96097,
	96137, 96149, 96157, 96167, 96179, 96181, 96199, 96211, 96221, 96223,
	96233, 96259, 96263, 96269, 96281, 96289, 96293, 96323, 96329, 96331,
	96337, 96353, 96377, 96401, 96419, 96431, 96443, 96451, 96457, 96461,
	96469, 96479, 96487, 96493, 96497, 96517, 96527, 96553, 96557, 96581,
	96587, 96589, 96601, 96643, 96661, 96667, 96671, 96697, 96703, 96731,
	96737, 96739, 96749, 96757, 96763, 96769, 96779, 96787, 96797, 96799,
	96821, 96823, 96827, 96847, 96851, 96857, 96893, 96907, 96911, 96931,
	96953, 96959, 96973, 96979, 96989, 96997, 97001, 97003, 97007, 97021,
	97039, 97073, 97081, 97103, 97117, 97127, 97151, 97157, 97159, 97169,
	97171, 97177, 97187, 97213, 97231, 97241, 97259, 97283, 97301, 97303,
	97327, 97367, 97369, 97373, 97379, 97381, 97387, 97397, 97423, 97429,
	97441, 97453, 97459, 97463, 97499, 97501, 97511, 97523, 97547, 97549,
	97553, 97561, 97571, 97577, 97579, 97583, 97607, 97609, 97613, 97649,
	97651, 97673, 97687, 97711, 97729, 97771, 97777, 97787, 97789, 97813,
	97829, 97841, 97843, 97847, 97849, 97859, 97861, 97871, 97879, 97883,
	97919, 97927, 97931, 97943, 97961, 97967, 97973, 97987, 98009, 98011,
	98017, 98041, 98047, 98057, 98081, 98101, 98123, 98129, 98143, 98179,
	98207, 98213, 98221, 98227, 98251, 98257, 98269, 98297, 98299, 98317,
	98321, 98323, 98327, 98347, 98369, 98377, 98387, 98389, 98407, 98411,
	98419, 98429, 98443, 98453, 98459, 98467, 98473, 98479, 98491, 98507,
	98519, 98533, 98543, 98561, 98563, 98573, 98597, 98621, 98627, 98639,
	98641, 98663, 98669, 98689, 98711, 98713, 98717, 98729, 98731, 98737,
	98773, 98779, 98801, 98807, 98809, 98837, 98849, 98867, 98869, 98873,
	98887, 98893, 98897, 98899, 98909, 98911, 98927, 98929, 98939, 98947,
	98953, 98963, 98981, 98993, 98999, 99013, 99017, 99023, 99041, 99053,
	99079, 99083, 99089, 99103, 99109, 99119, 99131, 99133, 99137, 99139,
	99149, 99173, 99181, 99191, 99223, 99233, 99241, 99251, 99257, 99259,
	99277, 99289, 99317, 99347, 99349, 99367, 99371, 99377, 99391, 99397,
	99401, 99409, 99431, 99439, 99469, 99487, 99497, 99523, 99527, 99529,
	99551, 99559, 99563, 99571, 99577, 99581, 99607, 99611, 99623, 99643,
	99661, 99667, 99679, 99689, 99707, 99709, 99713, 99719, 99721, 99733,
	99761, 99767, 99787, 99793, 99809, 99817, 99823, 99829, 99833, 99839,
	99859, 99871, 99877, 99881, 99901, 99907, 99923, 99929, 99961, 99971,
	99989, 99991, 100003, 100019, 100043, 100049, 100057, 100069, 100103,
	100109, 100129, 100151, 100153, 100169, 100183, 100189, 100193, 100207, 100213,
	100237, 100267, 100271, 100279, 100291, 100297, 100313, 100333, 100343, 100357,
	100361, 100363, 100379, 100391, 100393, 100403, 100411, 100417, 100447, 100459,
	100469, 100483, 100493, 100501, 100511, 100517, 100519, 100523, 100537, 100547,
	100549, 100559, 100591, 100609, 100613, 100621, 100649, 100669, 100673, 100693,
	100699, 100703, 100733, 100741, 100747, 100769, 100787, 100799, 100801, 100811,
	100823, 100829, 100847, 100853, 100907, 100913, 100927, 100931, 100937, 100943,
	100957, 100981, 100987, 100999, 101009, 101021, 101027, 101051, 101063, 101081,
	101089, 101107, 101111, 101113, 101117, 101119, 101141, 101149, 101159, 101161,
	101173, 101183, 101197, 101203, 101207, 101209, 101221, 101267, 101273, 101279,
	101281, 101287, 101293, 101323, 101333, 101341, 101347, 101359, 101363, 101377,
	101383, 101399, 101411, 101419, 101429, 101449, 101467, 101477, 101483, 101489,
	101501, 101503, 101513, 101527, 101531, 101533, 101537, 101561, 101573, 101581,
	101599, 101603, 101611, 101627, 101641, 101653, 101663, 101681, 101693, 101701,
	101719, 101723, 101737, 101741, 101747, 101749, 101771, 101789, 101797, 101807,
	101833, 101837, 101839, 101863, 101869, 101873, 101879, 101891, 101917, 101921,
	101929, 101939, 101957, 101963, 101977, 101987, 101999, 102001, 102013, 102019,
	102023, 102031, 102043, 102059, 102061, 102071, 102077, 102079, 102101, 102103,
	102107, 102121, 102139, 102149, 102161, 102181, 102191, 102197, 102199, 102203,
	102217, 102229, 102233, 102241, 102251, 102253, 102259, 102293, 102299, 102301,
	102317, 102329, 102337, 102359, 102367, 102397, 102407, 102409, 102433, 102437,
	102451, 102461, 102481, 102497, 102499, 102503, 102523, 102533, 102539, 102547,
	102551, 102559, 102563, 102587, 102593, 102607, 102611, 102643, 102647, 102653,
	102667, 102673, 102677, 102679, 102701, 102761, 102763, 102769, 102793, 102797,
	102811, 102829, 102841, 102859, 102871, 102877, 102881, 102911, 102913, 102929,
	102931, 102953, 102967, 102983, 103001, 103007, 103043, 103049, 103067, 103069,
	103079, 103087, 103091, 103093, 103099, 103123, 103141, 103171, 103177, 103183,
	103217, 103231, 103237, 103289, 103291, 103307, 103319, 103333, 103349, 103357,
	103387, 103391, 103393, 103399, 103409, 103421, 103423, 103451, 103457, 103471,
	103483, 103511, 103529, 103549, 103553, 103561, 103567, 103573, 103577, 103583,
	103591, 103613, 103619, 103643, 103651, 103657, 103669, 103681, 103687, 103699,
	103703, 103723, 103769, 103787, 103801, 103811, 103813, 103837, 103841, 103843,
	103867, 103889, 103903, 103913, 103919, 103951, 103963, 103967, 103969, 103979,
	103981, 103991, 103993, 103997, 104003, 104009, 104021, 104033, 104047, 104053,
	104059, 104087, 104089, 104107, 104113, 104119, 104123, 104147, 104149, 104161,
	104173, 104179, 104183, 104207, 104231, 104233, 104239, 104243, 104281, 104287,
	104297, 104309, 104311, 104323, 104327, 104347, 104369, 104381, 104383, 104393,
	104399, 104417, 104459, 104471, 104473, 104479, 104491, 104513, 104527, 104537,
	104543, 104549, 104551, 104561, 104579, 104593, 104597, 104623, 104639, 104651,
	104659, 104677, 104681, 104683, 104693, 104701, 104707, 104711, 104717, 104723,
	104729
	};
/*
*initialize the array of random coprime multiplier and adder
*/ 
void initialize_generated(uint32_t array[][2])
{
	srand(time(NULL));
	uint32_t x,y,i;
	for(i = 0;i < 12 ;i++)
	{
		while((x = rand()%1600) != (y = rand()%1600))
		{
			array[i][0] = array_of_prime[x];
			array[i][1] = array_of_prime[y];
		}
	}
}

uint64_t* calculate_features(uint64_t cur_feature,uint64_t* features,uint64_t* hash_of_fp)
{
    if( INITIALIZE == 0)
    {
        initialize_generated(generated_multiplier_adder);
        INITIALIZE = 1;
    }
	uint32_t kth;
    for(kth = 0;kth < 12; kth++)
    {  
        uint64_t hash = ((uint64_t)(generated_multiplier_adder[kth][0] * cur_feature) + generated_multiplier_adder[kth][1]) % CONSTANT;
        if(hash > hash_of_fp[kth])
            features[kth] = cur_feature;
    }
    return features;
}
/*
*get fingerprint of current block
*/
uint64_t get_fp_of_block(char* buf, uint32_t len_of_buf)
{
    uint32_t SHA[8];
    uint8_t* src = (uint8_t*)buf;
    uint32_t len = len_of_buf;
    //call SHA-256 function
	zsha256(src, len, SHA);
    
	uint64_t fp = ((uint64_t) SHA[0] << 32) + SHA[1];
    return fp;
}
/*
*calculate 3 super_features with 12 given features 
*/
uint64_t* calculate_super_features(uint64_t* super_features,uint64_t* features)
{
	uint32_t j, k;
  	for(j = 0;j < 3; j++)
    	for(k = 0;k < 4; k++)
        	super_features[j] = ((uint64_t)(super_features[j] * PRIME) + features[j*4+k]) % CONSTANT;
	return super_features;
}
/*
*write data of chunk to file
*/
void write_chunk_to_file(void* buf,uint32_t len_of_buf,struct chunk* cur_chunk,const char* target)
{
	//tranform fingerprint into the form of string
    initialize_generated(generated_multiplier_adder);
	char name[17] = { 0 };
    sprintf(name, "%016lx", cur_chunk->fingerprint);
	//get target path
	char path_of_new_chunk[100] = { 0 };
    strcpy(path_of_new_chunk, target);
    strcat(path_of_new_chunk, name);
	FILE* ptr_to_new_chunk = fopen(path_of_new_chunk, "w");

    uint32_t bytes_write = 0;
    if(buf != NULL)
        bytes_write = fwrite((char*)buf, sizeof(char), len_of_buf, ptr_to_new_chunk);
    total_write_bytes += bytes_write;
    printf("total_write_bytes: %lu\n", total_write_bytes);
    fclose(ptr_to_new_chunk);
}

/*
 *get data of given chunk 
 */

char *get_chunk_from_file(char* ref, struct chunk* cur_chunk,const char* target)
{
	uint64_t fp_of_cur_chunk = cur_chunk->fingerprint;
    uint32_t len_of_cur_chunk = cur_chunk->length;
    char file_of_cur_chunk[17] = { 0 };
    sprintf(file_of_cur_chunk, "%016lx", fp_of_cur_chunk);
    
	char path_of_cur_chunk[100] = { 0 };
    strcpy(path_of_cur_chunk, target);
    strcat(path_of_cur_chunk, file_of_cur_chunk);
   // above: get target path 
	FILE* fptr = fopen(path_of_cur_chunk, "r");
	ref = (char*)malloc(sizeof(char) * len_of_cur_chunk);
    fread(ref, sizeof(char), len_of_cur_chunk, fptr);
    fclose(fptr);
    return ref;
} 


